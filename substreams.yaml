specVersion: v0.1.0
package:
  name: jupiter-dex-substreams
  version: v0.4.0
  url: https://github.com/PaulieB14/Jupiter-Dex-Substreams
  image: assets/icon.png
  description: "High-performance Substreams for Jupiter DEX on Solana with SQL sink support (PostgreSQL/ClickHouse), 75% data reduction, and comprehensive swap parsing for Jupiter v1-v6, Limit Orders, and DCA."

imports:
  sol: https://spkg.io/streamingfast/solana-common-v0.3.1.spkg
  database: https://github.com/streamingfast/substreams-sink-database-changes/releases/download/v3.0.0/substreams-sink-database-changes-v3.0.0.spkg
  sql: https://github.com/streamingfast/substreams-sink-sql/releases/download/protodefs-v1.0.7/substreams-sink-sql-protodefs-v1.0.7.spkg

binaries:
  default:
    type: wasm/rust-v1
    file: ./target/wasm32-unknown-unknown/release/jupiter_dex_substreams.wasm

protobuf:
  files:
    - jupiter/events/v1/events.proto
    - proto/sf/jupiter/v1/types.proto
  importPaths:
    - jupiter
    - proto
  excludePaths:
    - sf/substreams
    - google

network: solana

params:
  sol:transactions_by_programid_without_votes: "program:JUP6LkbZbjS1jKKwapdHNy74zcZ3tLUZoi5QNyVTaV4 || program:JUP4Fb2cqiRUcaTHdrPC8h2gNsA2ETXiPDD33WcGuJB || program:JUP3c2Uh3WA4Ng34tw6kPd2G4C5BB21Xo36Je1s32Ph || program:JUP2jxvXaqu7NQY1GmNF4m1vodw12LVXYxbFL2uJvfo || program:jupoNjAxXgZ4rjzxzPMP4oxduvQsQtZzyknqvzYNrNu || program:DCA265Vj8a9CEuX1eb1LWRnDT7uK6q1xMipnNyatn23M"

modules:
  # SPL Token account initialization tracking
  # Uses foundational module for 75% data reduction
  - name: map_spl_initialized_account
    kind: map
    initialBlock: 31310775
    blockFilter:
      module: sol:program_ids_without_votes
      query:
        string: "program:JUP6LkbZbjS1jKKwapdHNy74zcZ3tLUZoi5QNyVTaV4 || program:JUP4Fb2cqiRUcaTHdrPC8h2gNsA2ETXiPDD33WcGuJB || program:JUP3c2Uh3WA4Ng34tw6kPd2G4C5BB21Xo36Je1s32Ph || program:JUP2jxvXaqu7NQY1GmNF4m1vodw12LVXYxbFL2uJvfo || program:jupoNjAxXgZ4rjzxzPMP4oxduvQsQtZzyknqvzYNrNu || program:DCA265Vj8a9CEuX1eb1LWRnDT7uK6q1xMipnNyatn23M"
    inputs:
      - source: sf.solana.type.v1.Block
    output:
      type: proto:sf.jupiter.v1.AccountOwnerRecords

  # Core trading data extraction with swap amount parsing
  # Uses foundational module for 75% data reduction
  - name: map_jupiter_trading_data
    kind: map
    initialBlock: 31310775
    blockFilter:
      module: sol:program_ids_without_votes
      query:
        string: "program:JUP6LkbZbjS1jKKwapdHNy74zcZ3tLUZoi5QNyVTaV4 || program:JUP4Fb2cqiRUcaTHdrPC8h2gNsA2ETXiPDD33WcGuJB || program:JUP3c2Uh3WA4Ng34tw6kPd2G4C5BB21Xo36Je1s32Ph || program:JUP2jxvXaqu7NQY1GmNF4m1vodw12LVXYxbFL2uJvfo || program:jupoNjAxXgZ4rjzxzPMP4oxduvQsQtZzyknqvzYNrNu || program:DCA265Vj8a9CEuX1eb1LWRnDT7uK6q1xMipnNyatn23M"
    inputs:
      - source: sf.solana.type.v1.Block
    output:
      type: proto:sf.jupiter.v1.TradingDataList

  # Token price calculation from trading data
  - name: map_token_prices
    kind: map
    initialBlock: 31310775
    inputs:
      - map: map_jupiter_trading_data
    output:
      type: proto:sf.jupiter.v1.TokenPriceList

  # Enriched Jupiter instructions with account ownership, pricing, and parsed amounts
  - name: map_jupiter_instructions
    kind: map
    initialBlock: 31310775
    blockFilter:
      module: sol:program_ids_without_votes
      query:
        string: "program:JUP6LkbZbjS1jKKwapdHNy74zcZ3tLUZoi5QNyVTaV4 || program:JUP4Fb2cqiRUcaTHdrPC8h2gNsA2ETXiPDD33WcGuJB || program:JUP3c2Uh3WA4Ng34tw6kPd2G4C5BB21Xo36Je1s32Ph || program:JUP2jxvXaqu7NQY1GmNF4m1vodw12LVXYxbFL2uJvfo || program:jupoNjAxXgZ4rjzxzPMP4oxduvQsQtZzyknqvzYNrNu || program:DCA265Vj8a9CEuX1eb1LWRnDT7uK6q1xMipnNyatn23M"
    inputs:
      - source: sf.solana.type.v1.Block
      - map: map_spl_initialized_account
      - map: map_jupiter_trading_data
      - map: map_token_prices
    output:
      type: proto:sf.jupiter.v1.JupiterInstructions

  # High-level analytics with volume tracking
  - name: map_jupiter_analytics
    kind: map
    initialBlock: 31310775
    inputs:
      - map: map_jupiter_instructions
    output:
      type: proto:sf.jupiter.v1.JupiterAnalytics

  # Store: Track swap volumes by token pair
  - name: store_swap_volumes
    kind: store
    initialBlock: 31310775
    updatePolicy: add
    valueType: bigint
    inputs:
      - map: map_jupiter_trading_data

  # Store: Track unique traders (wallets)
  - name: store_unique_traders
    kind: store
    initialBlock: 31310775
    updatePolicy: set_if_not_exists
    valueType: string
    inputs:
      - map: map_jupiter_trading_data

  # Database sink output (PostgreSQL/ClickHouse)
  # Transforms trading data and analytics into CDC records
  - name: db_out
    kind: map
    initialBlock: 31310775
    inputs:
      - map: map_jupiter_trading_data
      - map: map_jupiter_analytics
    output:
      type: proto:sf.substreams.sink.database.v1.DatabaseChanges

# SQL Sink Configuration
# Usage: substreams-sink-sql run "psql://..." jupiter-dex-substreams-v0.4.0.spkg
sink:
  module: db_out
  type: sf.substreams.sink.sql.v1.Service
  config:
    schema: ./schema.sql
    engine: postgres
